<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shop Earrings | YashStore</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/pages/products.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
</head>
<body>
    <header>
        <div class="container">
            <div class="logo">
                <a href="index.html"><h1>YashStore</h1></a>
            </div>
            <div class="cart-icon">
                <a href="cart.html"><i class="fas fa-shopping-cart"></i> <span id="cart-count">0</span></a>
            </div>
        </div>
    </header>

    <div class="page-content">
        <section class="page-header">
            <div class="container">
                <h1>Our Earring Collection</h1>
                <p>Find the perfect pair for any occasion</p>
            </div>
        </section>

        <section class="products">
            <div class="container">
                <!-- Category filter section -->
                <div class="category-filter" id="category-filter">
                    <button class="category-btn active" data-category="all">All Styles</button>
                    <button class="category-btn" data-category="style 01">Style 01</button>
                    <button class="category-btn" data-category="style 02">Style 02</button>
                    <button class="category-btn" data-category="style 03">Style 03</button>
                    <button class="category-btn" data-category="style 04">Style 04</button>
                </div>
                
                <div id="products-grid" class="products-grid">
                    <!-- Products will be dynamically loaded here by JavaScript -->
                    <div class="loading-products">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Loading products...</p>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <footer>
        <div class="container">
            <div class="copyright">
                <p>&copy; 2023 YashStore. All rights reserved. Powered by <a href="https://github.com/GihanPasidu" target="_blank">CloudNextra Solution</a>.</p>
            </div>
        </div>
    </footer>
    
    <script src="js/products-data.js"></script>
    <script src="js/main.js"></script>
    <script>
        // Netlify-specific initialization for products page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Initializing products page for Netlify');
            
            // Prevent multiple product rendering attempts when main.js is working correctly
            let productsRendered = false;
            
            // Force products to display correctly on Netlify with multiple attempts
            function attemptDisplayProducts() {
                console.log('Attempting to display products...', productsRendered ? '(already rendered)' : '(first attempt)');
                
                // Only proceed if products haven't been successfully rendered yet
                if (productsRendered) return;
                
                const productsGrid = document.getElementById('products-grid');
                if (!productsGrid) return;
                
                // Check if products have already been rendered
                if (productsGrid.querySelectorAll('.product-card').length > 0) {
                    console.log('Products already rendered, skipping duplicate render');
                    productsRendered = true;
                    return;
                }
                
                if (typeof displayProducts === 'function') {
                    displayProducts();
                    console.log('Called displayProducts function');
                    
                    // Check if products were actually rendered
                    setTimeout(() => {
                        if (productsGrid.querySelectorAll('.product-card').length > 0) {
                            console.log('Products rendered successfully');
                            productsRendered = true;
                        } else if (productsGrid.querySelector('.loading-products')) {
                            console.log('Products not rendered properly, retrying...');
                            if (!productsRendered) displayProducts(); // Try again only if not already rendered
                        }
                    }, 500);
                } else {
                    console.warn('displayProducts function not available yet');
                }
            }
            
            // Try immediate display
            setTimeout(attemptDisplayProducts, 100);
            
            // Try again after a short delay if needed
            setTimeout(attemptDisplayProducts, 500);
            
            // Final attempt with a longer delay if still needed
            setTimeout(attemptDisplayProducts, 1500);
            
            // Set up category filter functionality
            const categoryFilter = document.getElementById('category-filter');
            if (categoryFilter) {
                categoryFilter.addEventListener('click', function(e) {
                    if (e.target.classList.contains('category-btn')) {
                        const buttons = categoryFilter.querySelectorAll('.category-btn');
                        buttons.forEach(btn => btn.classList.remove('active'));
                        e.target.classList.add('active');
                        
                        const category = e.target.getAttribute('data-category');
                        console.log('Filtering products by category:', category);
                        
                        if (typeof filterProductsByCategory === 'function') {
                            filterProductsByCategory(category);
                        } else {
                            console.warn('filterProductsByCategory function not available');
                            // Fallback filtering implementation
                            if (window.products) {
                                const filtered = category === 'all' ? 
                                    window.products : 
                                    window.products.filter(p => p.category === category);
                                displayProducts(filtered);
                            }
                        }
                    }
                });
            }
            
            // Fallback method if products still don't load
            setTimeout(() => {
                const productsGrid = document.getElementById('products-grid');
                if (productsGrid && (productsGrid.children.length <= 1 || 
                    productsGrid.querySelector('.loading-products'))) {
                    
                    console.log('Using emergency fallback for product display');
                    
                    // Check if window.products exists
                    if (window.products && Array.isArray(window.products) && window.products.length > 0) {
                        productsGrid.innerHTML = ''; // Clear loading state
                        
                        // Manual rendering of products
                        window.products.forEach(product => {
                            const productCard = document.createElement('div');
                            productCard.className = 'product-card';
                            
                            // Make sure product name is properly displayed
                            const productName = product.name || 'Earrings';
                            
                            productCard.innerHTML = `
                                <div class="product-image loading">
                                    <img src="${product.image}" alt="${productName}" 
                                         onerror="this.src='https://via.placeholder.com/300x300?text=Earrings'; this.classList.add('loaded');">
                                    <div class="product-overlay">
                                        <button class="add-to-cart" data-id="${product.id}">Add to Cart</button>
                                        <button class="view-details" data-id="${product.id}">View Details</button>
                                    </div>
                                </div>
                                <div class="product-info">
                                    <h3>${productName}</h3>
                                    <p class="price">Rs ${product.price.toFixed(2)}</p>
                                </div>
                            `;
                            
                            productsGrid.appendChild(productCard);
                        });
                        
                        // Add event listeners
                        document.querySelectorAll('.add-to-cart').forEach(button => {
                            button.addEventListener('click', function() {
                                const id = parseInt(this.getAttribute('data-id'));
                                const cart = JSON.parse(localStorage.getItem('cart') || '[]');
                                const product = window.products.find(p => p.id === id);
                                
                                if (product) {
                                    const existingItem = cart.find(item => item.id === id);
                                    if (existingItem) {
                                        existingItem.quantity += 1;
                                    } else {
                                        cart.push({
                                            id: product.id,
                                            name: product.name,
                                            price: product.price,
                                            image: product.image,
                                            quantity: 1
                                        });
                                    }
                                    
                                    localStorage.setItem('cart', JSON.stringify(cart));
                                    
                                    // Update cart count
                                    const cartCount = document.getElementById('cart-count');
                                    if (cartCount) {
                                        const count = cart.reduce((total, item) => total + item.quantity, 0);
                                        cartCount.textContent = count.toString();
                                    }
                                    
                                    alert(`${product.name} added to cart!`);
                                }
                            });
                        });
                        
                        document.querySelectorAll('.view-details').forEach(button => {
                            button.addEventListener('click', function() {
                                const id = parseInt(this.getAttribute('data-id'));
                                window.location.href = `product-details.html?id=${id}`;
                            });
                        });
                    } else {
                        productsGrid.innerHTML = `
                            <div class="no-products">
                                <p>Unable to load products. Please refresh the page or try again later.</p>
                                <button onclick="window.location.reload()" class="btn">Refresh Page</button>
                            </div>
                        `;
                    }
                }
            }, 2000);
            
            // Add special handling for add to cart buttons on Netlify
            document.body.addEventListener('click', function(e) {
                // Handle add to cart button clicks with event delegation
                if (e.target.classList.contains('add-to-cart') || e.target.closest('.add-to-cart')) {
                    const button = e.target.classList.contains('add-to-cart') ? e.target : e.target.closest('.add-to-cart');
                    const id = parseInt(button.getAttribute('data-id'));
                    console.log('Add to cart clicked via delegation for ID:', id);
                    
                    if (typeof addToCart === 'function') {
                        addToCart(id);
                    }
                }
            });
        });
    </script>
</body>
</html>
