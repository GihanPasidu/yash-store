<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopping Cart | YashStore</title>
    
    <!-- Add resource hints for faster loading -->
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    <!-- Inline critical CSS -->
    <style>
        /* Critical styles for cart page */
        header{background-color:white;box-shadow:0 2px 10px rgba(0,0,0,.1);position:sticky;top:0;z-index:1000}
        header .container{display:flex;justify-content:space-between;align-items:center;padding:15px}
        .container{width:90%;max-width:1200px;margin:0 auto;padding:0 15px}
        .logo h1{color:#e74c3c;font-size:1.8rem;margin:0;letter-spacing:1px;text-transform:uppercase}
        #cart-count{position:absolute;top:-10px;right:-10px;background-color:#e74c3c;color:#fff;border-radius:50%;font-size:.7rem;padding:2px 6px}
    </style>
    
    <!-- Load critical CSS first -->
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/pages/cart.css">
    
    <!-- Defer non-critical resources -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" media="print" onload="this.media='all'">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
    
    <!-- Fallback in case JS is disabled -->
    <noscript>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
        <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    </noscript>
</head>
<body>
    <header>
        <div class="container">
            <div class="logo">
                <a href="index.html"><h1>YashStore</h1></a>
            </div>
            <div class="cart-icon">
                <a href="cart.html"><i class="fas fa-shopping-cart"></i> <span id="cart-count">0</span></a>
            </div>
        </div>
    </header>

    <div class="page-content">
        <section class="page-header">
            <div class="container">
                <div class="back-navigation">
                    <a href="products.html" class="back-button"><i class="fas fa-arrow-left"></i> Back to Products</a>
                </div>
                <h1>Shopping Cart</h1>
                <p>Review your items and checkout</p>
            </div>
        </section>

        <section class="cart-container">
            <div class="container">
                <div class="cart-grid">
                    <div id="cart-items" class="cart-items-container">
                        <!-- Cart items will be dynamically loaded here -->
                        <div class="cart-empty-placeholder">
                            <i class="fas fa-shopping-cart"></i>
                            <p>Your cart is currently empty.</p>
                            <a href="products.html" class="btn">Continue Shopping</a>
                        </div>
                    </div>
                    <div class="cart-summary">
                        <h2>Order Summary</h2>
                        <div class="summary-item">
                            <span>Subtotal:</span>
                            <span id="cart-subtotal">Rs 0.00</span>
                        </div>
                        <div class="summary-item">
                            <span>Shipping:</span>
                            <span id="shipping-cost">Free</span>
                        </div>
                        <div class="summary-item discount-row">
                            <span>Discount:</span>
                            <span id="discount-amount">Rs 0.00</span>
                        </div>
                        <hr>
                        <div class="summary-total">
                            <span>Total:</span>
                            <span id="cart-total">Rs 0.00</span>
                        </div>
                        <div class="promo-code">
                            <h3>Promo Code</h3>
                            <div class="promo-input">
                                <input type="text" id="promo-code" placeholder="Enter promo code">
                                <button id="apply-promo" class="btn-small">Apply</button>
                            </div>
                        </div>
                        <a href="checkout.html" class="btn checkout-btn">Proceed to Checkout</a>
                        <div class="continue-shopping">
                            <a href="products.html"><i class="fas fa-arrow-left"></i> Continue Shopping</a>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <footer>
        <div class="container">
            <div class="copyright">
                <p>&copy; 2025 YashStore. All rights reserved. Powered by <a href="https://github.com/GihanPasidu" target="_blank">CloudNextra Solution</a>.</p>
            </div>
        </div>
    </footer>
    
    <script src="js/products-data.js" defer></script>
    <script src="js/main.js" defer></script>
    <script>
        // Inline critical initialization code
        document.addEventListener('DOMContentLoaded', function() {
            // Update cart icon immediately for better user experience
            const cartCount = document.getElementById('cart-count');
            if (cartCount) {
                const cart = JSON.parse(localStorage.getItem('cart') || '[]');
                const count = cart.reduce((total, item) => total + item.quantity, 0);
                cartCount.textContent = count.toString();
            }
            
            // Faster rendering of cart placeholder while waiting for full initialization
            const cartContainer = document.getElementById('cart-items');
            if (cartContainer && !cartContainer.children.length) {
                cartContainer.innerHTML = `
                    <div class="cart-loading-placeholder" style="display:flex;align-items:center;justify-content:center;height:200px;">
                        <div style="text-align:center;">
                            <div class="spinner" style="border:4px solid #f3f3f3;border-top:4px solid #e74c3c;border-radius:50%;width:30px;height:30px;margin:0 auto 15px;animation:spin 1s linear infinite;"></div>
                            <p>Loading cart...</p>
                        </div>
                    </div>
                `;
            }
            
            // Add animation styles
            const style = document.createElement('style');
            style.textContent = '@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}';
            document.head.appendChild(style);
        });
        
        // Netlify-specific fixes for cart functionality
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Initializing cart page with enhanced display mechanism');
            
            // Force cart rendering with multiple highly reliable methods
            const FORCE_SHOW_STYLE = 'display: block !important; visibility: visible !important; opacity: 1 !important; height: auto !important; overflow: visible !important; position: relative !important; z-index: 9999 !important;';
            
            // Super reliable cart renderer - completely self-contained to avoid dependencies
            function renderCart() {
                console.log('Running super reliable cart renderer');
                
                // Get cart items container - critical element
                const cartContainer = document.getElementById('cart-items');
                if (!cartContainer) {
                    console.error('Cart container not found - critical error');
                    return;
                }
                
                // Force container visibility with critical CSS
                cartContainer.setAttribute('style', FORCE_SHOW_STYLE);
                
                // Get cart data directly from localStorage
                const cartRaw = localStorage.getItem('cart');
                console.log('Raw cart data:', cartRaw);
                
                // Parse cart or use empty array if no cart exists
                const cart = cartRaw ? JSON.parse(cartRaw) : [];
                console.log('Parsed cart data:', cart);
                
                // Get elements for totals
                const cartSubtotalEl = document.getElementById('cart-subtotal');
                const cartTotalEl = document.getElementById('cart-total');
                const discountAmountEl = document.getElementById('discount-amount');
                
                // Clear existing content
                cartContainer.innerHTML = '';
                
                // Handle empty cart case
                if (!cart || !Array.isArray(cart) || cart.length === 0) {
                    console.log('Cart is empty, showing empty cart message');
                    cartContainer.innerHTML = `
                        <div class="cart-empty-placeholder">
                            <i class="fas fa-shopping-cart"></i>
                            <p>Your cart is currently empty.</p>
                            <a href="products.html" class="btn">Continue Shopping</a>
                        </div>
                    `;
                    
                    // Update totals to zero
                    if (cartSubtotalEl) cartSubtotalEl.textContent = 'Rs 0.00';
                    if (cartTotalEl) cartTotalEl.textContent = 'Rs 0.00';
                    if (discountAmountEl) discountAmountEl.textContent = 'Rs 0.00';
                    
                    // Hide checkout button
                    const checkoutBtn = document.querySelector('.checkout-btn');
                    if (checkoutBtn) checkoutBtn.style.display = 'none';
                    
                    return;
                }
                
                // Show checkout button when items exist
                const checkoutBtn = document.querySelector('.checkout-btn');
                if (checkoutBtn) checkoutBtn.style.display = 'block';
                
                // Calculate order total
                let total = 0;
                
                // Create and append cart items
                cart.forEach(item => {
                    // Skip invalid items
                    if (!item || !item.id) {
                        console.warn('Invalid cart item:', item);
                        return;
                    }
                    
                    // Calculate item total
                    const itemTotal = item.price * item.quantity;
                    total += itemTotal;
                    
                    // Create cart item element
                    const cartItemDiv = document.createElement('div');
                    cartItemDiv.className = 'cart-item';
                    
                    // Apply critical CSS for guaranteed visibility
                    cartItemDiv.setAttribute('style', 
                        'display: grid !important; grid-template-columns: 100px 1fr auto !important; gap: 25px !important; padding: 20px !important; visibility: visible !important; opacity: 1 !important; position: relative !important; z-index: 5 !important; background: white !important; border-radius: 8px !important; margin-bottom: 10px !important; box-shadow: 0 2px 10px rgba(0,0,0,0.05) !important;');
                    
                    // Generate item HTML
                    cartItemDiv.innerHTML = `
                        <div class="cart-item-image">
                            <img src="${item.image || ''}" alt="${item.name || 'Product'}" 
                                 onerror="this.src='https://via.placeholder.com/300x300?text=Earrings';">
                        </div>
                        <div class="cart-item-details">
                            <h3>${item.name || 'Product'}</h3>
                            <p class="price">Rs ${(item.price || 0).toFixed(2)}</p>
                            <div class="quantity-control">
                                <button class="quantity-btn minus" data-id="${item.id}" style="min-height:44px; min-width:44px;">-</button>
                                <input type="number" value="${item.quantity || 1}" min="1" class="quantity-input" data-id="${item.id}">
                                <button class="quantity-btn plus" data-id="${item.id}" style="min-height:44px; min-width:44px;">+</button>
                            </div>
                            <button class="remove-item" data-id="${item.id}" style="min-height:44px;">
                                <i class="fas fa-trash"></i> Remove
                            </button>
                        </div>
                        <div class="cart-item-price">
                            <p class="item-total">Rs ${itemTotal.toFixed(2)}</p>
                        </div>
                    `;
                    
                    // Append to container
                    cartContainer.appendChild(cartItemDiv);
                    
                    // Apply mobile-specific styles if needed
                    if (window.innerWidth < 768) {
                        if (window.innerWidth < 480) {
                            // Extremely small screens
                            cartItemDiv.setAttribute('style', 
                                'display: grid !important; grid-template-columns: 1fr !important; gap: 15px !important; padding: 15px !important; text-align: center !important; visibility: visible !important; opacity: 1 !important; position: relative !important; z-index: 5 !important; background: white !important; border-radius: 8px !important; margin-bottom: 10px !important; box-shadow: 0 2px 10px rgba(0,0,0,0.05) !important;');
                        } else {
                            // Regular mobile screens
                            cartItemDiv.setAttribute('style', 
                                'display: grid !important; grid-template-columns: 80px 1fr !important; gap: 15px !important; padding: 15px !important; visibility: visible !important; opacity: 1 !important; position: relative !important; z-index: 5 !important; background: white !important; border-radius: 8px !important; margin-bottom: 10px !important; box-shadow: 0 2px 10px rgba(0,0,0,0.05) !important;');
                        }
                    }
                });
                
                // Update order totals
                if (cartSubtotalEl) cartSubtotalEl.textContent = `Rs ${total.toFixed(2)}`;
                if (cartTotalEl) cartTotalEl.textContent = `Rs ${total.toFixed(2)}`;
                if (discountAmountEl) discountAmountEl.textContent = 'Rs 0.00';
                
                // Set up event listeners for cart items
                setupCartControls();
            }
            
            // Cart controls setup - completely self-contained
            function setupCartControls() {
                // Plus buttons
                document.querySelectorAll('.plus').forEach(btn => {
                    btn.onclick = function() {
                        updateQuantity(parseInt(this.getAttribute('data-id')), 1);
                    };
                });
                
                // Minus buttons
                document.querySelectorAll('.minus').forEach(btn => {
                    btn.onclick = function() {
                        updateQuantity(parseInt(this.getAttribute('data-id')), -1);
                    };
                });
                
                // Remove buttons
                document.querySelectorAll('.remove-item').forEach(btn => {
                    btn.onclick = function() {
                        removeItem(parseInt(this.getAttribute('data-id')));
                    };
                });
                
                // Quantity inputs
                document.querySelectorAll('.quantity-input').forEach(input => {
                    input.onchange = function() {
                        const id = parseInt(this.getAttribute('data-id'));
                        const newValue = parseInt(this.value);
                        
                        if (!isNaN(newValue) && newValue > 0) {
                            setQuantity(id, newValue);
                        }
                    };
                });
                
                // Set up promo code functionality
                const applyPromoBtn = document.getElementById('apply-promo');
                if (applyPromoBtn) {
                    // Remove any existing listeners
                    const newBtn = applyPromoBtn.cloneNode(true);
                    applyPromoBtn.parentNode.replaceChild(newBtn, applyPromoBtn);
                    
                    newBtn.addEventListener('click', function() {
                        const promoInput = document.getElementById('promo-code');
                        const discountAmount = document.getElementById('discount-amount');
                        const cartTotal = document.getElementById('cart-total');
                        const cartSubtotal = document.getElementById('cart-subtotal');
                        
                        if (promoInput && promoInput.value.trim() !== '') {
                            const subtotalText = cartSubtotal.textContent;
                            const subtotal = parseFloat(subtotalText.replace('Rs ', ''));
                            
                            if (promoInput.value.trim().toUpperCase() === 'YASH10') {
                                const discount = subtotal * 0.1;
                                discountAmount.textContent = `Rs ${discount.toFixed(2)}`;
                                cartTotal.textContent = `Rs ${(subtotal - discount).toFixed(2)}`;
                                alert('Promo code applied successfully!');
                            } else {
                                alert('Invalid promo code');
                            }
                        } else {
                            alert('Please enter a promo code');
                        }
                    });
                }
            }
            
            // Helper function to update quantity
            function updateQuantity(id, change) {
                console.log(`Updating quantity for item ${id} by ${change}`);
                const cart = JSON.parse(localStorage.getItem('cart') || '[]');
                const item = cart.find(item => item.id === id);
                
                if (item) {
                    const newQuantity = item.quantity + change;
                    if (newQuantity <= 0) {
                        removeItem(id);
                    } else {
                        item.quantity = newQuantity;
                        localStorage.setItem('cart', JSON.stringify(cart));
                        updateCartIcon();
                        renderCart();
                    }
                }
            }
            
            // Helper function to set specific quantity
            function setQuantity(id, quantity) {
                console.log(`Setting quantity for item ${id} to ${quantity}`);
                const cart = JSON.parse(localStorage.getItem('cart') || '[]');
                const item = cart.find(item => item.id === id);
                
                if (item) {
                    item.quantity = quantity;
                    localStorage.setItem('cart', JSON.stringify(cart));
                    updateCartIcon();
                    renderCart();
                }
            }
            
            // Helper function to remove item
            function removeItem(id) {
                console.log(`Removing item ${id} from cart`);
                const cart = JSON.parse(localStorage.getItem('cart') || '[]');
                const newCart = cart.filter(item => item.id !== id);
                localStorage.setItem('cart', JSON.stringify(newCart));
                updateCartIcon();
                renderCart();
            }
            
            // Update cart icon count
            function updateCartIcon() {
                const cartCount = document.getElementById('cart-count');
                if (cartCount) {
                    const cart = JSON.parse(localStorage.getItem('cart') || '[]');
                    const count = cart.reduce((total, item) => total + item.quantity, 0);
                    cartCount.textContent = count.toString();
                    // Add visual feedback
                    cartCount.classList.add('updating');
                    setTimeout(() => cartCount.classList.remove('updating'), 300);
                }
            }
            
            // Run cart renderer multiple times to ensure display
            renderCart();
            setTimeout(renderCart, 300);
            setTimeout(renderCart, 1000);
            
            // Add global event delegation for cart buttons
            document.body.addEventListener('click', function(e) {
                // Find closest button if clicked on child element
                const button = e.target.closest('button');
                if (!button) return;
                
                // Handle plus buttons
                if (button.classList.contains('plus')) {
                    const id = parseInt(button.getAttribute('data-id'));
                    if (!isNaN(id)) updateQuantity(id, 1);
                }
                
                // Handle minus buttons
                if (button.classList.contains('minus')) {
                    const id = parseInt(button.getAttribute('data-id'));
                    if (!isNaN(id)) updateQuantity(id, -1);
                }
                
                // Handle remove buttons
                if (button.classList.contains('remove-item')) {
                    const id = parseInt(button.getAttribute('data-id'));
                    if (!isNaN(id)) removeItem(id);
                }
            });
            
            // Initialize cart count
            updateCartIcon();
        });
    </script>
</body>
</html>
